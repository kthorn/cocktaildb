<!DOCTYPE html>
<html lang="en">

<head>
    <title>Analytics - Mixology Tools</title>
    <!-- Prevent FOUC (Flash of Unstyled Content) with common.js fallback -->
</head>

<body>
    <!-- Header will be loaded by common.js -->

    <main class="analytics-container">
        <section class="analytics-header">
            <h2>Database Analytics</h2>
            <p class="analytics-description">
                Explore insights and statistics about cocktail recipes and ingredients in the database.
            </p>
            <div class="analytics-meta">
                <span id="last-updated"></span>
            </div>
        </section>

        <!-- Navigation tabs for different analytics views -->
        <nav class="analytics-tabs">
            <button class="tab-button active" data-tab="ingredients">
                Ingredient Usage
            </button>
            <button class="tab-button" data-tab="ingredient-tree">
                Ingredient Tree
            </button>
            <button class="tab-button" data-tab="complexity">
                Recipe Complexity
            </button>
            <button class="tab-button" data-tab="cocktail-space">
                Cocktail Space (Manhattan)
            </button>
            <button class="tab-button" data-tab="cocktail-space-em">
                Cocktail Space (EM)
            </button>
        </nav>

        <!-- Mobile view selector (hidden on desktop) -->
        <div class="analytics-view-selector">
            <label for="mobile-view-select" class="view-selector-label">View:</label>
            <select id="mobile-view-select" class="mobile-view-select">
                <option value="ingredients" selected>Ingredient Usage</option>
                <option value="ingredient-tree">Ingredient Tree</option>
                <option value="complexity">Recipe Complexity</option>
                <option value="cocktail-space">Cocktail Space (Manhattan)</option>
                <option value="cocktail-space-em">Cocktail Space (EM)</option>
            </select>
        </div>

        <!-- Tab content containers -->
        <div class="analytics-content">
            <!-- Ingredient Usage Tab -->
            <section id="tab-ingredients" class="tab-content active">
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Ingredient Usage by Recipe Count</h3>
                        <p class="card-description">
                            Click on an ingredient to explore its subtypes.
                            Usage counts include all child ingredients.
                        </p>
                    </div>

                    <!-- Breadcrumb navigation for hierarchy -->
                    <div id="ingredient-breadcrumb" class="breadcrumb-nav hidden">
                        <button class="breadcrumb-item" data-level="root">
                            All Ingredients
                        </button>
                    </div>

                    <div class="chart-container">
                        <div id="ingredient-usage-chart" class="chart-area">
                            <!-- D3.js chart will be rendered here -->
                        </div>
                        <div id="ingredient-chart-loading" class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading ingredient data...</p>
                        </div>
                        <div id="ingredient-chart-error" class="error-state hidden">
                            <p class="error-message"></p>
                            <button class="btn btn-primary retry-btn">Retry</button>
                        </div>
                    </div>

                    <!-- Chart legend and info -->
                    <div class="chart-info">
                        <div class="legend">
                            <span class="legend-item">
                                <span class="legend-color" style="background: #1f77b4;"></span>
                                Has subtypes (click to expand)
                            </span>
                            <span class="legend-item">
                                <span class="legend-color" style="background: #aec7e8;"></span>
                                Leaf ingredient
                            </span>
                        </div>
                        <div class="chart-stats">
                            <span id="ingredients-shown-count">-</span> ingredients displayed
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ingredient Tree Tab -->
            <section id="tab-ingredient-tree" class="tab-content">
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Ingredient Hierarchy Tree</h3>
                        <p class="card-description">
                            Interactive radial tree showing ingredient relationships. Click nodes to expand/collapse.
                            Hover to see recipe counts (direct and with children).
                        </p>
                    </div>

                    <div class="chart-container" style="min-height: 700px;">
                        <div id="ingredient-tree-chart" class="chart-area" style="height: 700px;">
                            <!-- D3.js tree will be rendered here -->
                        </div>
                        <div id="ingredient-tree-loading" class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading ingredient tree...</p>
                        </div>
                        <div id="ingredient-tree-error" class="error-state hidden">
                            <p class="error-message"></p>
                            <button class="btn btn-primary retry-btn">Retry</button>
                        </div>
                    </div>

                    <div class="chart-info">
                        <!-- Note: Legend colors should match those in ingredientTreeChart.js getColors() -->
                        <div class="legend">
                            <span class="legend-item">
                                <span class="legend-color" style="background: var(--accent-color, #A61816);"></span>
                                Has children (click to expand)
                            </span>
                            <span class="legend-item">
                                <span class="legend-color" style="background: var(--primary-color, #2c3e50);"></span>
                                Leaf ingredient
                            </span>
                        </div>
                        <div class="chart-stats">
                            <span id="ingredient-tree-count">-</span> ingredients
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recipe Complexity Tab -->
            <section id="tab-complexity" class="tab-content">
                <div class="analytics-card">
                    <div class="card-header">
                        <h3>Recipe Complexity Distribution</h3>
                        <p class="card-description">
                            Distribution of recipes by number of ingredients.
                        </p>
                    </div>

                    <div class="chart-container">
                        <div id="recipe-complexity-chart" class="chart-area">
                            <!-- Chart will be rendered here -->
                        </div>
                        <div id="complexity-chart-loading" class="loading-state">
                            <div class="spinner"></div>
                            <p>Loading complexity data...</p>
                        </div>
                        <div id="complexity-chart-error" class="error-state hidden">
                            <p class="error-message"></p>
                            <button class="btn btn-primary retry-btn">Retry</button>
                        </div>
                    </div>

                    <div class="chart-info">
                        <div class="stats-summary">
                            <div class="stat-item">
                                <span class="stat-label">Average ingredients:</span>
                                <span id="avg-ingredients" class="stat-value">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Most common:</span>
                                <span id="mode-ingredients" class="stat-value">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        <!-- Cocktail Space Tab -->
        <div id="tab-cocktail-space" class="tab-content">
            <div class="analytics-card">
                <h2>Cocktail Space Visualization (Manhattan Distance)</h2>
                <p class="card-description">
                    Interactive map showing recipes positioned by ingredient similarity using Manhattan distance.
                    Hover over points to see recipe names. Click to view details.
                </p>

                <!-- Loading state -->
                <div id="cocktail-space-loading" class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading cocktail space...</p>
                </div>

                <!-- Error state -->
                <div id="cocktail-space-error" class="error-state hidden">
                    <p class="error-message"></p>
                    <button class="btn btn-primary retry-btn">Retry</button>
                </div>

                <!-- Chart container -->
                <div id="cocktail-space-chart" class="chart-container"></div>

                <div class="analytics-stats">
                    <div class="stat-item">
                        <span class="stat-label">Recipes:</span>
                        <span id="cocktail-space-count" class="stat-value">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cocktail Space EM Tab -->
        <div id="tab-cocktail-space-em" class="tab-content">
            <div class="analytics-card">
                <h2>Cocktail Space Visualization (EM Learner)</h2>
                <p class="card-description">
                    Interactive map showing recipes positioned by ingredient similarity using learned distances from the EM algorithm.
                    Ingredients are rolled up to parent categories for dimensional reduction.
                    Hover over points to see recipe names. Click to view details.
                </p>

                <!-- Loading state -->
                <div id="cocktail-space-em-loading" class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading cocktail space...</p>
                </div>

                <!-- Error state -->
                <div id="cocktail-space-em-error" class="error-state hidden">
                    <p class="error-message"></p>
                    <button class="btn btn-primary retry-btn">Retry</button>
                </div>

                <!-- Chart container -->
                <div id="cocktail-space-em-chart" class="chart-container"></div>

                <div class="analytics-stats">
                    <div class="stat-item">
                        <span class="stat-label">Recipes:</span>
                        <span id="cocktail-space-em-count" class="stat-value">-</span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Info footer -->
        <section class="analytics-footer">
            <p class="info-text">
                Analytics are updated automatically when recipes or ingredients are modified.
            </p>
        </section>

        <!-- Recipe Detail Modal -->
        <div id="recipe-modal" class="modal hidden">
            <div class="modal-backdrop"></div>
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <div id="recipe-modal-body">
                    <!-- Loading state -->
                    <div id="recipe-modal-loading" class="modal-loading">
                        <div class="spinner"></div>
                        <p>Loading recipe...</p>
                    </div>
                    <!-- Recipe card will be inserted here -->
                    <div id="recipe-modal-card"></div>
                </div>
                <div class="modal-footer">
                    <a id="recipe-modal-link" href="#" target="_blank" class="btn-primary">View Full Recipe</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer will be loaded by common.js -->

    <!-- Load D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Load application scripts -->
    <script type="module" src="js/common.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/charts/ingredientUsageChart.js"></script>
    <script type="module" src="js/charts/ingredientTreeChart.js"></script>
    <script type="module" src="js/charts/recipeComplexityChart.js"></script>
    <script type="module" src="js/charts/cocktailSpaceChart.js"></script>
    <script type="module" src="js/analytics.js"></script>
</body>

</html>
