# infrastructure/ansible/playbooks/migrate-data.yml
---
- name: Migrate SQLite data to PostgreSQL
  hosts: cocktaildb
  become: yes

  vars:
    db_name: "{{ lookup('env', 'COCKTAILDB_DB_NAME') | default('cocktaildb', true) }}"
    db_user: "{{ lookup('env', 'COCKTAILDB_DB_USER') | default('cocktaildb', true) }}"
    db_password: "{{ lookup('env', 'COCKTAILDB_DB_PASSWORD') }}"
    backup_bucket: "{{ lookup('env', 'COCKTAILDB_BACKUP_BUCKET') }}"
    sqlite_path: "{{ lookup('env', 'COCKTAILDB_SQLITE_PATH') | default('', true) }}"
    local_sqlite: "{{ lookup('env', 'COCKTAILDB_LOCAL_SQLITE') | default('', true) }}"

  tasks:
    - name: Copy local SQLite file to EC2
      copy:
        src: "{{ local_sqlite }}"
        dest: /tmp/local_backup.db
        mode: '0644'
      when: local_sqlite != ""

    - name: Set sqlite_path when using local file
      set_fact:
        sqlite_path: /tmp/local_backup.db
      when: local_sqlite != ""

    - name: Ensure required variables are set
      fail:
        msg: "{{ item.name }} must be set"
      when: item.value == ""
      loop:
        - { name: "COCKTAILDB_DB_PASSWORD", value: "{{ db_password }}" }
        - { name: "COCKTAILDB_BACKUP_BUCKET, COCKTAILDB_SQLITE_PATH, or COCKTAILDB_LOCAL_SQLITE", value: "{{ backup_bucket }}{{ sqlite_path }}{{ local_sqlite }}" }

    - name: Copy migration script
      copy:
        src: "{{ playbook_dir }}/../../scripts/migrate-sqlite-to-postgres.py"
        dest: /tmp/migrate-sqlite-to-postgres.py
        mode: '0755'

    - name: Copy PostgreSQL schema
      copy:
        src: "{{ playbook_dir }}/../../postgres/schema.sql"
        dest: /tmp/schema.sql
        mode: '0644'

    - name: Run migration from S3 backup
      shell: |
        python3 /tmp/migrate-sqlite-to-postgres.py \
          --s3-bucket "{{ backup_bucket }}" \
          --schema /tmp/schema.sql \
          --pg-password "{{ db_password }}" \
          --pg-db "{{ db_name }}" \
          --pg-user "{{ db_user }}"
      when: backup_bucket != "" and sqlite_path == ""
      register: migration_result

    - name: Run migration from local SQLite file
      shell: |
        python3 /tmp/migrate-sqlite-to-postgres.py \
          --sqlite "{{ sqlite_path }}" \
          --schema /tmp/schema.sql \
          --pg-password "{{ db_password }}" \
          --pg-db "{{ db_name }}" \
          --pg-user "{{ db_user }}"
      when: sqlite_path != ""
      register: migration_result_local

    - name: Show migration result
      debug:
        msg: "{{ (migration_result.stdout | default(migration_result_local.stdout | default(''))).split('\n') }}"

    - name: Cleanup
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/migrate-sqlite-to-postgres.py
        - /tmp/schema.sql
        - /tmp/cocktaildb_backup.db
        - /tmp/local_backup.db
