# infrastructure/ansible/playbooks/deploy.yml
---
- name: Deploy CocktailDB Application
  hosts: cocktaildb
  become: yes

  vars:
    app_home: /opt/cocktaildb
    app_user: cocktaildb
    app_group: cocktaildb

  tasks:
    # Validate required environment variables
    - name: Check COCKTAILDB_DB_PASSWORD is set
      fail:
        msg: |
          COCKTAILDB_DB_PASSWORD environment variable must be set.
          Run: export COCKTAILDB_DB_PASSWORD='your-password'
      when: db_password is not defined or db_password == ""

    - name: Warn if using default password in production
      fail:
        msg: |
          Cannot use default password 'changeme' in production.
          Set COCKTAILDB_DB_PASSWORD to the actual database password.
      when: app_env == 'prod' and db_password == 'changeme'

    # Sync API code
    - name: Sync API code to server
      synchronize:
        src: "{{ playbook_dir }}/../../../api/"
        dest: "{{ app_home }}/api/"
        delete: yes
        rsync_opts:
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=.pytest_cache"
          - "--exclude=tests/"
          - "--exclude=*.db"
      notify: Restart API

    # Sync frontend code
    - name: Sync frontend code to server
      synchronize:
        src: "{{ playbook_dir }}/../../../src/web/"
        dest: "{{ app_home }}/web/"
        delete: yes
        rsync_opts:
          - "--exclude=config.js"
      notify: Restart Caddy

    # Ensure packages directory exists
    - name: Create packages directory
      file:
        path: "{{ app_home }}/packages"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    # Sync barcart analytics package
    - name: Sync barcart package to server
      synchronize:
        src: "{{ playbook_dir }}/../../../packages/barcart/"
        dest: "{{ app_home }}/packages/barcart/"
        delete: yes
        rsync_opts:
          - "--exclude=__pycache__"
          - "--exclude=*.pyc"
          - "--exclude=.pytest_cache"
          - "--exclude=tests/"

    # Generate config.js from template (environment-specific)
    - name: Generate frontend config.js
      template:
        src: ../files/config.js.j2
        dest: "{{ app_home }}/web/js/config.js"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
      notify: Restart Caddy

    # Copy docker-compose files
    - name: Copy docker-compose files
      copy:
        src: "{{ item }}"
        dest: "{{ app_home }}/"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
      loop:
        - "{{ playbook_dir }}/../../../docker-compose.yml"
        - "{{ playbook_dir }}/../../../docker-compose.prod.yml"
      notify: Restart API

    # Copy repo .dockerignore for root build context
    - name: Copy docker ignore
      copy:
        src: "{{ playbook_dir }}/../../../.dockerignore"
        dest: "{{ app_home }}/.dockerignore"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'

    # Copy deployment scripts
    - name: Copy deployment scripts
      copy:
        src: "{{ playbook_dir }}/../../scripts/"
        dest: "{{ app_home }}/scripts/"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
        directory_mode: '0755'

    # Copy systemd units
    - name: Copy systemd service units
      copy:
        src: "{{ playbook_dir }}/../../systemd/"
        dest: /etc/systemd/system/
        owner: root
        group: root
        mode: '0644'
      notify: Daemon reload

    - name: Copy analytics debounce script
      copy:
        src: "{{ playbook_dir }}/../../scripts/analytics-debounce-check.sh"
        dest: /usr/local/bin/analytics-debounce-check.sh
        owner: root
        group: root
        mode: '0755'

    - name: Install polkit rule for analytics debounce
      copy:
        src: "{{ playbook_dir }}/../files/cocktaildb-analytics.rules"
        dest: /etc/polkit-1/rules.d/49-cocktaildb-analytics.rules
        owner: root
        group: root
        mode: '0644'
      notify: Restart polkit

    # Deploy Caddy configuration
    - name: Copy Caddyfile
      copy:
        src: "{{ playbook_dir }}/../../caddy/Caddyfile"
        dest: /etc/caddy/Caddyfile
        owner: root
        group: root
        mode: '0644'
      notify: Restart Caddy

    # Configure Caddy environment variables (domain, ACME email)
    - name: Create Caddy systemd override directory
      file:
        path: /etc/systemd/system/caddy.service.d
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Configure Caddy environment variables
      copy:
        dest: /etc/systemd/system/caddy.service.d/override.conf
        content: |
          [Service]
          Environment=DOMAIN_NAME={{ domain_name }}
          Environment=ACME_EMAIL=admin@{{ domain_name }}
        owner: root
        group: root
        mode: '0644'
      notify:
        - Daemon reload
        - Restart Caddy

    # Create environment file from template
    - name: Create environment file
      template:
        src: ../files/env.j2
        dest: "{{ app_home }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0600'
      notify: Restart API

    - name: Create analytics directory
      file:
        path: /var/lib/cocktaildb/analytics
        state: directory
        owner: "1000"
        group: "1000"
        mode: '0755'

    # Ensure correct ownership
    - name: Set ownership of app directory
      file:
        path: "{{ app_home }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        recurse: yes

    # Build Docker image
    - name: Build Docker image
      community.docker.docker_image:
        name: cocktaildb-api
        tag: latest
        source: build
        build:
          path: "{{ app_home }}"
          dockerfile: api/Dockerfile.prod
        force_source: yes
      notify: Restart API

    # Start API container
    - name: Start API with Docker Compose
      shell: |
        cd {{ app_home }}
        docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

    # Enable systemd timers
    - name: Enable backup timer
      systemd:
        name: cocktaildb-backup.timer
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Enable analytics timer
      systemd:
        name: cocktaildb-analytics.timer
        enabled: no
        state: stopped

    - name: Enable analytics debounce timer
      systemd:
        name: cocktaildb-analytics-debounce.timer
        enabled: yes
        state: started

  handlers:
    - name: Daemon reload
      systemd:
        daemon_reload: yes

    - name: Restart API
      shell: |
        cd {{ app_home }}
        docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --force-recreate

    - name: Restart polkit
      systemd:
        name: polkit
        state: restarted

    - name: Restart Caddy
      systemd:
        name: caddy
        state: restarted
