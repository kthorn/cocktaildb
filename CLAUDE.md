# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### FastAPI Development (New)
- **Run FastAPI locally**: `cd api && python main.py` or `uvicorn api.main:app --reload`
- **Run with Docker**: `docker-compose up --build`
- **FastAPI tests**: `pytest tests/test_fastapi.py -v`
- **API documentation**: Access `/docs` or `/redoc` in dev environment

### Deployment
- **Deploy to dev**: `scripts\deploy.bat dev` 
- **Deploy to prod**: `scripts\deploy.bat prod` (requires HOSTED_ZONE_ID env var)
- **Deploy without build**: `scripts\deploy.bat dev --no-build`

### Database Operations  
- **Apply migration**: `.\scripts\apply-migration.ps1 -SqlFilePath "path\to\migration.sql"`
- **Force DB reinitialization**: `.\scripts\apply-migration.ps1 -SqlFilePath "schema.sql" -ForceInit`

### AWS SAM Operations
- **Build**: `sam build --template-file template.yaml`
- **Local testing**: Use `sam local` commands with template.yaml

### Testing
- **Run tests**: `python -m pytest tests/` 
- **Test database**: `python tests/test_db.py`
- **FastAPI tests**: `pytest tests/test_fastapi.py`

## Architecture Overview

**CocktailDB** is a serverless cocktail recipe management application with the following key components:

### Database Layer (`cocktaildb/db/`)
- **SQLite on Amazon EFS**: Shared database across Lambda instances
- **Connection pooling**: Global `_DB_INSTANCE` persists between Lambda invocations
- **Schema management**: `schema-deploy/schema.sql` defines current schema state
- **Key tables**: `recipes`, `ingredients` (hierarchical), `recipe_ingredients`, `ratings`, `units`, tags

### API Layer (`api/`)
- **FastAPI Application**: `main.py` - modern FastAPI app with automatic documentation
- **Legacy Lambda Handler**: `handler.py` - original Lambda entry point (being phased out)
- **Route Modules**: `routes/` directory with organized endpoint handlers
- **Authentication**: `dependencies/auth.py` - FastAPI dependencies for JWT validation
- **Database interface**: `db/db_core.py` (Database class), `db/sql_queries.py` (SQL constants)
- **Request/Response Models**: `models/` directory with Pydantic models

### Frontend (`src/web/`)
- **Static web app**: Vanilla JavaScript, served via CloudFront + S3
- **API client**: `js/api.js` - centralized backend communication  
- **Authentication**: `js/auth.js` - Cognito integration and token management
- **Configuration**: `js/config.js` - generated by `scripts/generate_config.py`

### Infrastructure (`template.yaml`)
- **AWS SAM template**: Defines all AWS resources
- **Multi-environment**: dev/prod configurations with conditional resources
- **Key resources**: Lambda functions, API Gateway, Cognito User Pool, S3, CloudFront, EFS

## Key Patterns

### FastAPI Application Structure
- **Route Organization**: Endpoints organized in `routes/` modules by resource type
- **Dependency Injection**: Use FastAPI dependencies for database and authentication
- **Pydantic Models**: Request/response validation with `models/requests.py` and `models/responses.py`
- **Error Handling**: Global exception handlers in `core/exception_handlers.py`

### Database Access
- Use FastAPI dependency `get_db()` for database injection
- Database connection cached globally as `_DB_INSTANCE` with connection pooling
- SQL queries stored as constants in `db/sql_queries.py`

### Authentication Flow (FastAPI)
- **Dependencies**: Use `get_current_user()` or `get_current_user_optional()` 
- **Token Validation**: Automatic JWT validation via FastAPI security dependencies
- **User Context**: `UserInfo` object provides structured user data
- **Route Protection**: Add `user: UserInfo = Depends(require_authentication)` to protect endpoints

### Legacy Authentication (Lambda)
- JWT tokens validated using `get_user_from_token()` in `auth.py`
- User ID extracted from Cognito claims for user-specific operations
- Anonymous access allowed for read-only operations

### API Response Format
- **FastAPI**: Return Pydantic response models directly, automatic serialization
- **Legacy**: Use utility functions from `utils.py`: `_return_data()`, `_return_error()`, `_return_message()`

### Frontend API Integration  
- All backend calls go through `CocktailAPI` class in `api.js`
- Authentication tokens automatically included in requests
- Error handling centralized with user-friendly messages
- **API Paths**: Both `/api/v1/` (new) and legacy paths supported for backward compatibility

## Database Schema Patterns

### Hierarchical Ingredients
- Ingredients support parent-child relationships
- Path-based storage (e.g., `/1/23/45/`) for efficient hierarchy queries
- Search includes child ingredients when filtering by parent

### User-Specific Data
- Ratings and private tags tied to Cognito user IDs
- Public tags shared across all users
- Recipe ownership tracked by `created_by` field

### Computed Fields
- Recipe ratings automatically aggregated via database triggers
- Average rating and count maintained in `recipes` table

## Development Notes

### Environment Configuration
- **Dev environment**: Uses default CloudFront domain
- **Prod environment**: Requires HOSTED_ZONE_ID for custom domain
- Stack names: `cocktail-db-dev` / `cocktail-db-prod`

### Schema Management
- Main schema in `schema-deploy/schema.sql`
- Migrations applied via `scripts/apply-migration.ps1` 
- Database initialization handled by `SchemaDeployFunction` Lambda

### Deployment Process
1. SAM builds and packages Lambda functions
2. CloudFormation deploys infrastructure
3. `generate_config.py` creates frontend configuration
4. Web content uploaded to S3
5. CloudFront cache invalidated