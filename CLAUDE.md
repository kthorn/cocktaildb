# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Environment Setup
- **Environment**: `cocktaildb` conda environment is pre-activated at startup

### Scripts

- **Unix migration script**: `./scripts/apply-migration.sh -f path/to/migration.sql -e dev`
- **Unix force reinit**: `./scripts/apply-migration.sh -f schema.sql -e dev --force-init`
  ⚠️ **Warning:** This operation will delete and recreate the existing database. All current data will be lost!

### Analytics Operations
- **Trigger analytics refresh**: `./scripts/trigger-analytics-refresh.sh [dev|prod]`
- **View analytics**: GET `/api/v1/analytics/ingredient-usage` and `/api/v1/analytics/recipe-complexity`
- Analytics automatically refresh after recipe/ingredient mutations

### Local Development
- **Setup local environment**: `./scripts/local-config.sh` - Generate local dev config pointing to dev API
- **Start local server**: `./scripts/serve.sh` - Serve frontend on http://localhost:8000
- **Start with live-reload**: `npx live-server src/web --port=8000` - Auto-refresh on file changes
- **Stop server**: Press `Ctrl+C`
- **Restore prod config**: `git checkout src/web/js/config.js` - Before committing
- **Documentation**: See `docs/local-development.md` for detailed setup and troubleshooting

### Testing
- **Run tests**: `python -m pytest tests/`
- **Test database**: `python tests/test_db.py`
- **FastAPI tests**: `pytest tests/test_fastapi.py`

### Issue Tracking (Beads)
- **List ready work**: `bd ready` - Show issues with no blockers
- **Create issue**: `bd create "title" --type TYPE --priority N` - Types: bug, feature, task, epic, chore
- **List all issues**: `bd list`
- **Show details**: `bd show ID`
- **Update status**: `bd update ID --status STATUS` - Status: open, in_progress, blocked, closed
- **Add dependency**: `bd dep add CHILD PARENT` - CHILD depends on PARENT (use underscores in status values)
- **View dependency tree**: `bd dep tree ID`
- **Find blocked work**: `bd blocked`
- **View statistics**: `bd stats`
- **Documentation**: See skills/tools/beads/SKILL.md for workflows and patterns

## Architecture Overview

**CocktailDB** is a cocktail recipe management application running on EC2 with PostgreSQL.

### Packages (`packages/`)
- **Barcart**: Cocktail analytics algorithms (similarity, distance metrics)
  - Location: `packages/barcart/`
  - Purpose: Recipe/ingredient similarity using Earth Mover's Distance and optimal transport
  - Dependencies: numpy, pandas, POT, tqdm, joblib
  - Installation: `pip install -e packages/barcart`
  - Tests: `pytest packages/barcart/tests/`
  - **Data-agnostic**: Works with DataFrames, database access handled by callers

### Database Layer (`api/db/`)
- **PostgreSQL on EC2**: Database runs on EC2 instance alongside the API
- **Connection pooling**: Uses `psycopg2.pool.ThreadedConnectionPool` for efficient connections
- **Core database class**: `db_core.py` (Database class with all database operations)
- **Analytics queries**: `db_analytics.py` (AnalyticsQueries class for pre-computed analytics)
- **Schema management**: `infrastructure/postgres/schema.sql` defines PostgreSQL schema
- **SQL queries**: Stored as constants in `sql_queries.py`
- **Key tables**: `recipes`, `ingredients` (hierarchical), `recipe_ingredients`, `ratings`, `units`, tags

### API Layer (`api/`)
- **FastAPI Application**: `main.py` - modern FastAPI app with automatic documentation and CORS middleware
- **Route Modules**: `routes/` directory with organized endpoint handlers (recipes, ingredients, ratings, units, tags, auth, analytics)
- **Authentication**: `dependencies/auth.py` - FastAPI dependencies for JWT validation
- **Exception Handling**: `core/exceptions.py` (custom exception classes), `core/exception_handlers.py` (global handlers)
- **Configuration**: `core/config.py` - application settings and environment configuration
- **Request/Response Models**: `models/` directory with Pydantic models for API validation
- **Database Integration**: Uses `db/database.py` dependency injection for database access
- **Utility Functions**: `utils/analytics_cache.py` (S3 storage manager for analytics)

### Frontend (`src/web/`)
- **Static web app**: Vanilla JavaScript, served via Caddy on EC2
- **API client**: `js/api.js` - centralized backend communication
- **Authentication**: `js/auth.js` - Cognito integration and token management
- **Configuration**: `js/config.js` - generated by `scripts/generate_config.py`

### Infrastructure

#### EC2 Deployment (`infrastructure/`)
- **Ansible playbooks**: `infrastructure/ansible/` - automated EC2 provisioning and deployment
- **Caddy config**: `infrastructure/caddy/Caddyfile` - reverse proxy and static file serving
- **PostgreSQL**: `infrastructure/postgres/` - database schema and configuration
- **Systemd**: `infrastructure/systemd/` - service definitions for API
- **Scripts**: `infrastructure/scripts/` - deployment and maintenance scripts

#### AWS Resources (`template.yaml`)
- **CloudFormation template**: Shared AWS resources (EC2 managed separately via Ansible)
- **Cognito**: User pool, client, groups, OAuth providers for authentication
- **S3 Buckets**: Analytics cache, backups (prod only)
- **IAM**: EC2 role and instance profile for S3 access
- **DNS**: Route 53 records for domain (prod only)
- **Deploy**: `aws cloudformation deploy --template-file template.yaml --stack-name cocktaildb-dev --capabilities CAPABILITY_NAMED_IAM`

## Key Patterns

### FastAPI Application Structure
- **Route Organization**: Endpoints organized in `routes/` modules by resource type
- **Dependency Injection**: Use FastAPI dependencies for database and authentication
- **Pydantic Models**: Request/response validation with `models/requests.py` and `models/responses.py`
- **Error Handling**: Global exception handlers in `core/exception_handlers.py`

### Database Access
- Use FastAPI dependency `get_database()` from `db/database.py` for database injection
- Database connection cached globally as `_DB_INSTANCE` with 5-minute cache duration (300 seconds)
- Core database operations in `Database` class from `db/db_core.py`
- SQL queries stored as constants in `db/sql_queries.py`
- **Dependency pattern**: `db: Database = Depends(get_database)` in route handlers
- **Environment variables**: `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`

### Authentication Flow (FastAPI)
- **Dependencies**: Use `get_current_user()` or `get_current_user_optional()`
- **Token Validation**: Automatic JWT validation via FastAPI security dependencies
- **User Context**: `UserInfo` object provides structured user data
- **Route Protection**: Add `user: UserInfo = Depends(require_authentication)` to protect endpoints

### API Response Format
- **FastAPI**: Return Pydantic response models directly, automatic serialization
- **Error Handling**: Custom exceptions (`CocktailDBException`, `DatabaseException`, `NotFoundException`, etc.) with structured error responses
- **Response Models**: Standardized response classes in `models/responses.py` (e.g., `ErrorResponse`, `MessageResponse`)
- **Validation**: Automatic request validation with detailed error messages via `RequestValidationError` handler

### Frontend API Integration
- All backend calls go through `CocktailAPI` class in `api.js`
- Authentication tokens automatically included in requests
- Error handling centralized with user-friendly messages
- **API Paths**: Both `/api/v1/` (new) and legacy paths supported for backward compatibility

### Pagination and Search
- **Paginated Endpoints**: `/api/recipes/search` supports pagination with `page` and `limit` parameters (note: `/api/recipes` does not support GET - use `/api/recipes/search` instead)
- **Response Format**: Includes `pagination` metadata with `total_count`, `total_pages`, `has_next`, `has_previous`
- **Search Features**: Full-text search, ingredient filtering, rating filters, tag filtering
- **Sorting**: Configurable sort fields (`name`, `created_at`, `avg_rating`) and order (`asc`, `desc`)

### Analytics Backend
- **Architecture**: Static pre-generated analytics stored in S3, served via API endpoints
- **Storage**: JSON files in S3 (`AnalyticsBucket`) with versioned keys (`analytics/v1/{type}.json`)
- **Components**:
  - `db/db_analytics.py`: Database queries for ingredient usage and recipe complexity statistics
  - `utils/analytics_cache.py`: S3 storage manager (`AnalyticsStorage` class)
  - `routes/analytics.py`: API endpoints with S3-first fallback to on-the-fly computation
- **Endpoints**:
  - GET `/api/v1/analytics/ingredient-usage?level={N}&parent_id={id}` - hierarchical ingredient usage stats
  - GET `/api/v1/analytics/recipe-complexity` - recipe complexity distribution
- **Manual Refresh**: `./scripts/trigger-analytics-refresh.sh [dev|prod]`
- **Caching Strategy**: S3-first retrieval with graceful fallback to on-the-fly computation

## Database Schema Patterns

### Hierarchical Ingredients
- Ingredients support parent-child relationships
- Path-based storage (e.g., `/1/23/45/`) for efficient hierarchy queries
- Search includes child ingredients when filtering by parent

### User-Specific Data
- Ratings and private tags tied to Cognito user IDs
- Public tags shared across all users
- Recipe ownership tracked by `created_by` field

### Computed Fields
- Recipe ratings automatically aggregated via database triggers
- Average rating and count maintained in `recipes` table

## Development Notes

### Environment Configuration
- **Dev environment**: `dev.mixology.tools` - EC2 with PostgreSQL
- **Prod environment**: `mixology.tools` - EC2 with PostgreSQL (after migration)
- **Cognito**: Shared user pool managed via CloudFormation

### EC2 Operations
- **AMI**: Amazon Linux 2023 ECS-optimized (ARM64) - user is `ec2-user`, NOT `ubuntu`
- **SSH via Instance Connect** (key expires in 60 seconds):
  ```bash
  # Push key and SSH in one command
  aws ec2-instance-connect send-ssh-public-key \
    --instance-id i-0317e7975318095c6 \
    --instance-os-user ec2-user \
    --ssh-public-key file://~/.ssh/id_ed25519.pub && \
  ssh -i ~/.ssh/id_ed25519 ec2-user@35.171.47.29 "YOUR_COMMAND"
  ```
- **Get instance ID**: `aws ec2 describe-instances --filters "Name=tag:Name,Values=cocktaildb-dev" --query 'Reservations[0].Instances[0].InstanceId' --output text`
- **Service runs in Docker**: `sudo docker ps` (not systemd)
- **View API logs**: `sudo docker logs cocktaildb-api-1 --tail 50`
- **Restart API**: `cd /opt/cocktaildb && sudo docker compose restart`
- **Check Caddy**: `sudo systemctl status caddy`
- **Documentation**: See `docs/operations-runbook.md`

### Deployment Process
1. Push changes to repository
2. SSH to EC2 instance
3. Pull latest code and restart service
4. Or use Ansible: `ansible-playbook -i infrastructure/ansible/inventory.yml infrastructure/ansible/deploy.yml`

### Debugging
- **Check API logs**: `sudo journalctl -u cocktaildb -f`
- **Check Caddy logs**: `sudo journalctl -u caddy -f`
- **PostgreSQL logs**: `sudo journalctl -u postgresql -f`
- **Local frontend testing**: Use `./scripts/local-config.sh && ./scripts/serve.sh` to test UI changes
- **Local API testing**: Run FastAPI locally with `cd api && python main.py`
