# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

### Environment Setup
- **Environment**: `cocktaildb` conda environment is pre-activated at startup

### FastAPI Development (New)
- **Run FastAPI locally**: `cd api && python main.py` or `uvicorn api.main:app --reload`
- **Run with Docker**: `docker-compose up --build`
- **FastAPI tests**: `pytest tests/test_fastapi.py -v`
- **API documentation**: Access `/docs` or `/redoc` in dev environment

### Deployment
- **Deploy to dev**: `scripts\deploy.bat dev` 
- **Deploy to prod**: `scripts\deploy.bat prod` (requires HOSTED_ZONE_ID env var)
- **Deploy without build**: `scripts\deploy.bat dev --no-build`

### Database Operations
- **Apply migration to dev**: `.\scripts\apply-migration.ps1 -SqlFilePath "path\to\migration.sql" -Environment dev`
- **Apply migration to prod**: `.\scripts\apply-migration.ps1 -SqlFilePath "path\to\migration.sql" -Environment prod`
- **Force DB reinitialization**: `.\scripts\apply-migration.ps1 -SqlFilePath "schema.sql" -Environment dev -ForceInit`
- **Unix migration script**: `./scripts/apply-migration.sh -f path/to/migration.sql -e dev`
- **Unix force reinit**: `./scripts/apply-migration.sh -f schema.sql -e dev --force-init`

### Analytics Operations
- **Trigger analytics refresh**: `./scripts/trigger-analytics-refresh.sh [dev|prod]`
- **View analytics**: GET `/api/v1/analytics/ingredient-usage` and `/api/v1/analytics/recipe-complexity`
- Analytics automatically refresh after recipe/ingredient mutations

### Database Backup & Restore
- **List available backups**: `.\scripts\restore-backup.ps1 -ListBackups` or `./scripts/restore-backup.sh --list`
- **Restore latest prod to dev**: `.\scripts\restore-backup.ps1 -TargetEnvironment dev -SourceEnvironment prod`
- **Restore specific backup**: `.\scripts\restore-backup.ps1 -TargetEnvironment dev -BackupFile "backup-2024-01-15_10-30-00.db"`
- **Unix restore latest prod to dev**: `./scripts/restore-backup.sh -t dev -s prod`
- **Unix restore specific backup**: `./scripts/restore-backup.sh -t dev -f backup-2024-01-15_10-30-00.db`
- **Dry run restore**: `./scripts/restore-backup.sh -t dev --dry-run`

### AWS SAM Operations
- **Build**: `sam build --template-file template.yaml`
- **Local testing**: Use `sam local` commands with template.yaml

### Testing
- **Run tests**: `python -m pytest tests/` 
- **Test database**: `python tests/test_db.py`
- **FastAPI tests**: `pytest tests/test_fastapi.py`
- **Download test database**: `./scripts/download-test-db.sh`

## Architecture Overview

**CocktailDB** is a serverless cocktail recipe management application with the following key components:

### Database Layer (`api/db/`)
- **SQLite on Amazon EFS**: Shared database across Lambda instances
- **Connection pooling**: Global `_DB_INSTANCE` persists between Lambda invocations via `database.py`
- **Core database class**: `db_core.py` (Database class with all database operations)
- **Analytics queries**: `db_analytics.py` (AnalyticsQueries class for pre-computed analytics)
- **Schema management**: `schema-deploy/schema.sql` defines current schema state
- **SQL queries**: Stored as constants in `sql_queries.py`
- **Key tables**: `recipes`, `ingredients` (hierarchical), `recipe_ingredients`, `ratings`, `units`, tags

### API Layer (`api/`)
- **FastAPI Application**: `main.py` - modern FastAPI app with automatic documentation and CORS middleware
- **Route Modules**: `routes/` directory with organized endpoint handlers (recipes, ingredients, ratings, units, tags, auth, analytics)
- **Authentication**: `dependencies/auth.py` - FastAPI dependencies for JWT validation
- **Exception Handling**: `core/exceptions.py` (custom exception classes), `core/exception_handlers.py` (global handlers)
- **Configuration**: `core/config.py` - application settings and environment configuration
- **Request/Response Models**: `models/` directory with Pydantic models for API validation
- **Database Integration**: Uses `db/database.py` dependency injection for database access
- **Utility Functions**: `utils/analytics_helpers.py` (async Lambda invocation), `utils/analytics_cache.py` (S3 storage manager)

### Frontend (`src/web/`)
- **Static web app**: Vanilla JavaScript, served via CloudFront + S3
- **API client**: `js/api.js` - centralized backend communication  
- **Authentication**: `js/auth.js` - Cognito integration and token management
- **Configuration**: `js/config.js` - generated by `scripts/generate_config.py`

### Infrastructure (`template.yaml`)
- **AWS SAM template**: Defines all AWS resources
- **Multi-environment**: dev/prod configurations with conditional resources
- **Key resources**: Lambda functions, API Gateway, Cognito User Pool, S3 (website, backups, analytics), CloudFront, EFS
- **Lambda Functions**:
  - `CocktailLambda`: Main API handler (FastAPI)
  - `AnalyticsRefreshFunction`: Async analytics regeneration
  - `SchemaDeployFunction`: Database schema initialization
  - `BackupLambda`: Nightly database backups (prod only)

## Key Patterns

### FastAPI Application Structure
- **Route Organization**: Endpoints organized in `routes/` modules by resource type
- **Dependency Injection**: Use FastAPI dependencies for database and authentication
- **Pydantic Models**: Request/response validation with `models/requests.py` and `models/responses.py`
- **Error Handling**: Global exception handlers in `core/exception_handlers.py`

### Database Access
- Use FastAPI dependency `get_database()` from `db/database.py` for database injection
- Database connection cached globally as `_DB_INSTANCE` with 5-minute cache duration (300 seconds)
- Core database operations in `Database` class from `db/db_core.py`
- SQL queries stored as constants in `db/sql_queries.py`
- **Dependency pattern**: `db: Database = Depends(get_database)` in route handlers

### Authentication Flow (FastAPI)
- **Dependencies**: Use `get_current_user()` or `get_current_user_optional()` 
- **Token Validation**: Automatic JWT validation via FastAPI security dependencies
- **User Context**: `UserInfo` object provides structured user data
- **Route Protection**: Add `user: UserInfo = Depends(require_authentication)` to protect endpoints

### API Response Format
- **FastAPI**: Return Pydantic response models directly, automatic serialization
- **Error Handling**: Custom exceptions (`CocktailDBException`, `DatabaseException`, `NotFoundException`, etc.) with structured error responses
- **Response Models**: Standardized response classes in `models/responses.py` (e.g., `ErrorResponse`, `MessageResponse`)
- **Validation**: Automatic request validation with detailed error messages via `RequestValidationError` handler

### Frontend API Integration  
- All backend calls go through `CocktailAPI` class in `api.js`
- Authentication tokens automatically included in requests
- Error handling centralized with user-friendly messages
- **API Paths**: Both `/api/v1/` (new) and legacy paths supported for backward compatibility

### Pagination and Search
- **Paginated Endpoints**: `/recipes` and `/recipes/search` support pagination with `page` and `limit` parameters
- **Response Format**: Includes `pagination` metadata with `total_count`, `total_pages`, `has_next`, `has_previous`
- **Search Features**: Full-text search, ingredient filtering, rating filters, tag filtering
- **Sorting**: Configurable sort fields (`name`, `created_at`, `avg_rating`) and order (`asc`, `desc`)

### Analytics Backend
- **Architecture**: Static pre-generated analytics stored in S3, served via API endpoints, async regeneration
- **Storage**: JSON files in S3 (`AnalyticsBucket`) with versioned keys (`analytics/v1/{type}.json`)
- **Components**:
  - `db/db_analytics.py`: Database queries for ingredient usage and recipe complexity statistics
  - `utils/analytics_cache.py`: S3 storage manager (`AnalyticsStorage` class)
  - `utils/analytics_helpers.py`: Async Lambda invocation (`trigger_analytics_refresh()`)
  - `routes/analytics.py`: API endpoints with S3-first fallback to on-the-fly computation
  - `analytics_refresh.py`: Lambda handler for regenerating analytics
- **Endpoints**:
  - GET `/api/v1/analytics/ingredient-usage?level={N}&parent_id={id}` - hierarchical ingredient usage stats
  - GET `/api/v1/analytics/recipe-complexity` - recipe complexity distribution
- **Automatic Refresh**: Mutation endpoints (create/update/delete recipes/ingredients) trigger async regeneration
- **Manual Refresh**: `./scripts/trigger-analytics-refresh.sh [dev|prod]`
- **Caching Strategy**: S3-first retrieval with graceful fallback to on-the-fly computation
- **Performance**: Pre-generated analytics reduce database load for expensive aggregate queries

## Database Schema Patterns

### Hierarchical Ingredients
- Ingredients support parent-child relationships
- Path-based storage (e.g., `/1/23/45/`) for efficient hierarchy queries
- Search includes child ingredients when filtering by parent

### User-Specific Data
- Ratings and private tags tied to Cognito user IDs
- Public tags shared across all users
- Recipe ownership tracked by `created_by` field

### Computed Fields
- Recipe ratings automatically aggregated via database triggers
- Average rating and count maintained in `recipes` table

## Development Notes

### Environment Configuration
- **Dev environment**: Uses default CloudFront domain
- **Prod environment**: Requires HOSTED_ZONE_ID for custom domain
- Stack names: `cocktail-db-dev` / `cocktail-db-prod`

### Schema Management
- Main schema in `schema-deploy/schema.sql`
- Migrations applied via `scripts/apply-migration.ps1` 
- Database initialization handled by `SchemaDeployFunction` Lambda

### Deployment Process
1. SAM builds and packages Lambda functions
2. CloudFormation deploys infrastructure
3. `generate_config.py` creates frontend configuration
4. Web content uploaded to S3
5. CloudFront cache invalidated

### Debugging
- **Check Lambda logs**: Use AWS CloudWatch logs to debug API errors
- **Error format**: Lambda errors typically show in format `[ERROR] timestamp request-id Error message`
- **Common issues**: Check method signatures, parameter counts, and data validation
- **Local testing**: Run FastAPI locally with `cd api && python main.py` for easier debugging